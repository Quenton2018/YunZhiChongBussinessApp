<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
    <title>我的充电桩</title>
    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/mui.min.js"></script>
    <style type="text/css">
    	.box-content{
    		background: #FFFFFF;
    	}
		.topBox{
			border: 1px solid #c4c4c4;
			border-width: 1px 0;
		}
		.rate-item{
			text-align: center;
			position: relative;
			padding: 25px 0;
		}
		.rate-left:after{
			position: absolute;
			right: 0;
			top: 0;
			height: 100%;
			width: 1px;
			background: #C4C4C4;
			content: '';
		}
		.rate-item .icon{
			width: 34px;
			height: 34px;
			display: inline-block;
			margin-right: 14px;
		}
		.rate-item .icon img{
			display: block;
   			width: 100%;
		}
		.rate-item .text-right{
			display: inline-block;
		}
		.rate-item h2{
			color: #ff6e0d;
			font-size: 22px;
		}
		.rate-item h2 sub{
			font-size: 12px;
			vertical-align: 4px;
			margin-left: 2px;
		}
		.rate-item h3{
			color: #333;
			font-size: 13px;
			font-weight: 400;			
		}
        .tabBox{
            text-align: center;
            margin: 10px 0;
            border: 1px solid #ff6d22;        
            border-radius: 6px;
            overflow: hidden;
        }
        .tabBox span{
            display: inline-block;
            padding:8px 0;
            background: #fff;
            border-right: 1px solid #ff6d22;
            font-size: 14px;
            text-align: center;
            color: #333;
        }
        .tabBox span:last-child{
        	border-right:none;
        }
        .tabBox span em{
        	padding: 0 5px;
        	font-size: 14px;
        	font-style: normal;
        }
        .tabBox span.select{
        	background: #ff6d22;
        	color: #fff;
        }
        .midRow{   
            background: #EEE;
		    padding: 15px;
		    font-size: 14px;
		    border-radius: 6px;
		    color: #000;
		    box-shadow: inset rgba(0,0,0,.16) 0px -3px 4px 1px;
		    overflow: hidden;
        }
		.midBox{
			padding: 10px;
    		background: #F0F1F3;
		}
        .mui-table-view{
            margin-top: 10px;
            background: none;
        }
        .mui-table-view li{
        	margin-bottom: 5px;
        	background: #fff;
        	border-radius: 6px;
        	font-size: 14px;
        	padding: 12px 15px;
        	box-shadow: inset #999 0px -1px 3px 0px;
        	overflow: hidden;
        }
        .mui-table-view-cell:after,.mui-table-view:after,.mui-table-view:before{
			height:0;
		}
        .mui-table-view .mui-badge{
            background: transparent;
            font-size: .9rem;
            text-align: right;
        }
		.list-row{
			overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
		}

    </style>

</head>
<body style="background: #F0F1F3">

<header class="header header-immersed mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">我的充电桩</h1>
</header>

<div id="J_refresh" class="mui-content mui-scroll-wrapper">
	<div class="mui-scroll">
		<div class="box-content">	
			<div class="topBox mui-row">
				<div class="rate-item rate-left mui-col-xs-6">
					<div class="icon">
						<img src="../images/partner/cdz_sum.png">
					</div>
					<div class="text-right">
						<h2><span id="countAll">0</span><sub>台</sub></h2>
						<h3>充电桩总数</h3>
					</div>		
				</div>
				<div class="rate-item rate-right mui-col-xs-6">
					<div class="icon">
						<img src="../images/partner/cdz_rate.png">
					</div>
					<div class="text-right">
						<h2>50<sub>%</sub></h2>
						<h3>充电桩使用率</h3>
					</div>			
				</div>
			</div>		    
		</div>
		
		<div class="midBox">
			<div class="tabBox flex">
		        <span id="normal" class="tabItem select mui-col-xs-4" data-type="0">充电桩详情</span>
		        <span id="abnormal"  class="tabItem mui-col-xs-4" data-type="2">异常充电桩(<em id="countInvalid">0</em>)</span>
		        <span class="tabItem mui-col-xs-4" data-type="3" >未安装(<em id="countUnInstall">0</em>)</span>
		    </div>
		    <div class="midRow mui-row">
		        <div class="mui-col-xs-6" id="leftBox">片区(<span id="groupCount">0</span>)</div>
		        <div class="mui-col-xs-3" id="rateBox" style="text-align: right;">使用率</div>
		        <div class="mui-col-xs-3" id="rightBox" style="text-align: right;padding-right: 10px;">台数</div>
		    </div>
		    <div class="normal">
		        <ul class="mui-table-view dataList">
		        	
		        </ul>
		    </div>
	    </div>
	</div>
</div>


<script type="text/html" id="dataTmpl">
    <li class="mui-table-view-cell">
        <a class="mui-navigate-right mui-row" onclick="{{jumpHtml}}" data-id="{{id}}"> <!-- areaList-->
            <span class="list-row mui-col-xs-6">{{groupName}}</span>
            <span class="list-row mui-col-xs-3" style="text-align: right;">50%</span>
            <span class="list-row mui-col-xs-3 mui-badge countBox" data-id="{{id}}">{{money}}</span>				            
        </a>
    </li>
</script>
<script type="text/html" id="dataTmpl2">
    <li class="mui-table-view-cell">
        <a class="mui-navigate-right" onclick="clicked('areaListUnNormal.html?id={{id}}')" data-id="{{id}}">
            <span class="mui-badge countBox" data-id="{{id}}">{{money}}</span>
            {{groupName}}
        </a>
    </li>
</script>
<script type="text/html" id="dataTmpl3">
    <li class="mui-table-view-cell">
        <a>
            <span class="mui-badge transDate" data-id="{{id}}">加载中</span>
            {{code}}
        </a>
    </li>
</script>


<script type="text/javascript">
	
	var btnType ="0";  //正常：0 异常：1
    var pageNumber = 1;
    var pageSize = 10;
    var type = 0;
    var uuid = '';
    
    $.pullRefresh(dataRefresh,function() {	
		pageNumber++;
        getChargingGroup(uuid);
	});
	
    mui.plusReady(function() {
        uuid = getUUId();      
    	checkLogin();
        getChargingCountByPartner(uuid);
        getChargingGroup(uuid);      
    });
	
	// 刷新页面
    function dataRefresh(){
        pageNumber=1;
        getChargingCountByPartner(uuid);
        getChargingGroup(uuid);
    }
    /**
     * 获取充电桩数量
     */
    function getChargingCountByPartner(uuid) {
        var param = {
            'uuid':uuid
        }      
        postJSON(API_URL.ApiChargingGetChargingCountByPartner, param, function(res){
            if("0" == res.code){
                $("#countAll").text(res.data.countAll);
                $("#countValid").text(res.data.countValid);
                $("#countInvalid").text(res.data.countInvalid);
                $("#countUnInstall").text(res.data.countUnInstall);
            }else{
                layer.msg(res.msg);
            }
        });
    }


    $(".tabItem").click(function(){

        type = $(this).attr("data-type");

        $(".tabItem").removeClass('select');
        $(this).addClass("select");

        pageNumber = 1;
		
        if(type != 3){
            $("#leftBox").html('片区(<span id="groupCount">0</span>)');
            if(type == 0){
            	$("#rateBox").html("使用率");
            }else{
            	$("#rateBox").html("");
            }       
            $("#rightBox").html("台数");
            getChargingGroup(uuid);
        }else{
            $("#leftBox").html("充电桩编号");
            $("#rateBox").html("");
            $("#rightBox").html("发货时间");
            getApplyCdzDataUnInstall();
        }

    })


    /**
     	抓取数据
    */
    function getChargingGroup(uuid){

        var dataParam= {
            "uuid":uuid,
            "pageSize":pageSize,
            "pageNumber":pageNumber,
            "type":type
        }

        postJSON(API_URL.ApiGetChargingGroup,dataParam,function(res){
            if("0" == res.code){
                if(1 == pageNumber){
                    $(".dataList").html('');
                }
                var data = res.data;
                
                mui('#J_refresh').pullRefresh().endPullupToRefresh(data.length == 0);
                
                if (data.length == 0 && pageNumber > 1) {
                	return;
                }

                getChargingGroupCount(dataParam);

                var html = '';
                var tmpl = $("#dataTmpl").html();
                if(2 == type){
                	var tmpl = $("#dataTmpl2").html();
                }
                var ids = '';
                var falgLast = true;
                var jumpHtml = '';
                $.each(data, function(index,item) {
                    var createDate = new Date(item.createDate).format("yyyy-MM-dd hh:mm:ss");
                    if(item.method){
                    	jumpHtml = "clicked('areaDataXinxi.html?id={{id}}')";
                    }else{
                    	jumpHtml = "clicked('areaInfoSetmeals.html?code={{id}}')";
                    }                
                    html += tmpl.replace(/{{createDate}}/g,createDate)
                        .replace(/{{groupName}}/g,item.name)
                        .replace(/{{jumpHtml}}/g,jumpHtml)
                        .replace(/{{sn}}/g,item.sn)
                        .replace(/{{id}}/g,item.id)
                        .replace(/{{money}}/g,'<img src="../images/5-121204194028.gif" height="15">');
                    ids += item.id+",";
                    if(index<9){
                        falgLast =true;
                    }else{
                        falgLast =false;
                    }
                });

                $(".dataList").append(html);

                getCount();

            }else{
                layer.msg(res.msg);
            }
        })
    }

    function getChargingGroupCount(dataParam) {
        postJSON(API_URL.ApiGetChargingGroupCount,dataParam,function (res) {
            $("#groupCount").text(res.data);
        })
    }

    function getCount(){

        var $countBox = $(".countBox");

        $.each($countBox,function (index,item) {

            var id = $(item).attr("data-id");

            postJSON(API_URL.ApiChargingGetChargingCountByGroupID,{"partnerUUID":"","groupID":id,"type":type},function (res) {
                $(".countBox[data-id='"+id+"']").html(res.data);
            })

        })

    }


    function getApplyCdzDataUnInstall(){
		var unInstallNum = parseInt($('#countUnInstall').html());
		unInstallNum = isNaN(unInstallNum) ? 10 : unInstallNum;
        var data = {
            "uuid":uuid,
            "pageSize":unInstallNum,
            "pageNumber":1
        }

        postJSON(API_URL.ApiChargingBusinessGetApplyCdzDataUnInstall,data,function (res) {
            if("0" == res.code){

                if(1 == pageNumber){
                    $(".dataList").html('');
                }
                var data = res.data;

                if(data.length == 0){
                    layer.msg("没有更多了")
                }

                var html = '';

                var dataTmpl3 = $("#dataTmpl3").html();

                $.each(data,function (index,item) {
                    html +=dataTmpl3.replace(/{{code}}/g,item.shellId)
                        .replace(/{{id}}/g,item.id);
                })

                $(".dataList").append(html);

                getTransDate();

            }else{
                layer.msg(res.msg);
            }

        })

    }
   
    function getTransDate() {
        var $transDate = $(".transDate");
        $.each($transDate,function (index,item) {
            var id = $(item).attr("data-id");
            if("加载中" == $(item).text()){
                postJSON(API_URL.ApiChargingBusinessGetApplyCdzDataTransDate,{"id":id},function (res) {
                    if(vaildeParam(res.data)){
                        $(item).text(res.data)
                    }else{
                        $(item).text('-')
                    }
                })
            }
        })        
    }
    

</script>
</body>

</html>