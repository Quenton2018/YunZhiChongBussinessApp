<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>桩申请信息</title>
    <link rel="stylesheet" href="../../css/mui.min.css">
    <link rel="stylesheet" href="../../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../../js/jquery-3.3.1.min.js"></script>
    <script src="../../js/bootstrap.min.js"></script>
    <script src="../../plugins/layer/layer.js"></script>
    <script src="../../js/hammer.min.js"></script>
    <script src="../../js/jquery.hammer.js"></script>
    <script src="../../js/common.js"></script>
    <script src="../../js/base.js"></script>
    <script src="../../js/mui.min.js"></script>
    <style type="text/css">
        *{margin:0;padding:0;text-decoration:none;list-style:none;font-weight:normal;border-style:none;}
        img{display:block;}
        body{background:#ececec;}
        .top{width:100%;height:44px;background:white;font-size:16px;color:white;text-align:center;line-height:44px;box-shadow:none;}
        .top .left{float:left;padding-left:30px;background:url("../../images/pianqushenqing/faihui@3x.png") 15px center no-repeat;background-size:12px 20px;height:44px;}
        .top h1{z-index:-100;margin:0;padding:0;color:black;}
        .conbox01{margin-top:64px;}
        .box01{padding:15px;border-bottom:1px solid #dce1e6;font-size:15px;color:#333333;background:white;}
        .conbox02{padding:15px;border-bottom:1px solid #dce1e6;background:white;}
        .box02{margin-bottom:30px;position:relative;}
        .box02 .xuhao{background:rgb(255,109,34);width:18px;height:18px;border-radius:100%;color:white;font-size:12px;text-align:center;line-height:18px;float:left;margin-right:8px;}
        .box02 h1{margin:0;padding:0;color:#333333;font-size:15px;float:left;}
        .box02 h2{margin:0;padding:0;color:#333333;font-size:12px;float:right;}
        .box02 h3{margin:0;padding:0;color:#333333;font-size:12px;margin-left:26px;margin-top:10px;}
        .box02 .xian{position:absolute;left:9px;top:18px;width:1px;height:52px;background:rgb(255,109,34);}
        .box03{margin-bottom:30px;position:relative;}
        .box03 .xian{position:absolute;left:9px;top:18px;width:1px;height:52px;background:#999999;}
        .box03 .xuhao{background:#999999;width:18px;height:18px;border-radius:100%;color:white;font-size:12px;text-align:center;line-height:18px;float:left;margin-right:8px;}
        .box03 h1{margin:0;padding:0;color:#999999;font-size:15px;float:left;}
        .box03 h2{margin:0;padding:0;color:#999999;font-size:12px;float:right;}
        .box03 h3{margin:0;padding:0;color:#999999;font-size:12px;margin-left:26px;margin-top:10px;}
        .box04{margin-top:15px;padding:15px;border-bottom:1px solid #dce1e6;background:white;}
        .box04 h1{margin:0;padding:0;font-size:15px;color:#333333;float:left;width:20%;line-height:22px;}
        .box04 textarea{font-size:15px;color:#333333;float:right;width:80%;line-height:22px;height:66px;border:none;margin:0;padding:0;}
        .conbox03{margin-top:15px;margin-bottom:65px;}
        .box05{padding:15px;border-bottom:1px solid #dce1e6;background:white;}
        .box05 h1{margin:0;padding:0;font-size:15px;float:left;color:#333333;}
        .box05 h2{margin:0;padding:0;font-size:15px;float:right;color:#333333;}
        .dbbt{background-image:-moz-linear-gradient(135deg,rgb(240,130,0) 0%,rgb(255,117,70) 100%);background-image:-webkit-linear-gradient(135deg,rgb(240,130,0) 0%,rgb(255,117,70) 100%);background-image:-ms-linear-gradient(135deg,rgb(240,130,0) 0%,rgb(255,117,70) 100%);height:49px;text-align:center;color:white;font-size:16px;line-height:49px;box-shadow:none;}
        .activeProgress{color:#000!important;}
        .activeProgress .xuhao{background:rgb(255,109,34)!important;}
        .activeProgress h1{color:#000!important;}
        .activeProgress .date{color:#000!important;}
        .activeProgress h3{color:#000!important;}
        .activeProgress .xian{background:rgb(255,109,34)!important;}
    </style>

</head>
<body>
	
<header class="header header-immersed mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">充电桩申请信息</h1>
</header>


<div class="btn-submit mui-bar mui-bar-tab" style="display: block" id="confirmGetBtn">
    确认收到货
</div>

<div class="mui-content">
    <div class="conbox01" style="margin-top: 20px;">
        <div class="box01">
            申请流程
        </div>
        <div class="conbox02">
            <div class=" box03 progressItem progressItem1">
                <div class="xian"></div>
                <div class="xuhao">1</div>
                <h1>申请已提交</h1>
                <h2 class="date"></h2>
                <div class="clearfix"></div>
                <h3>您的充电桩申请已成功提交</h3>
            </div>
            <div class="box03 progressItem progressItem2">
                <div class="xian" style="background: #999999;"></div>
                <div class="xuhao">2</div>
                <h1>审核通过</h1>
                <h2 class="date"></h2>
                <div class="clearfix"></div>
                <h3>您的充电桩申请已受理，并审核通过</h3>
            </div>
            <div class="box03 progressItem progressItem3">
                <div class="xian"></div>
                <div class="xuhao" style="background: #999999;">3</div>
                <h1>待发货</h1>
                <h2 class="date"></h2>
                <div class="clearfix"></div>
                <h3>您的充电桩申请已经成功核实，我们会尽快安排发货</h3>
            </div>
            <div class="box03 progressItem progressItem4">
                <div class="xian"></div>
                <div class="xuhao" style="background: #999999;">4</div>
                <h1>已发货</h1>
                <h2 class="date"></h2>
                <div class="clearfix"></div>
                <h3>您的充电桩已经发货，请注意查收</h3>
            </div>
            <div class="box03 progressItem progressItem5" style="margin-bottom: 0;">
                <div class="xuhao" style="background: #999999;">5</div>
                <h1>已收货</h1>
                <h2 class="date"></h2>
                <div class="clearfix"></div>
                <h3>您的充电桩已经被接收，请尽快安装</h3>
            </div>
            <div class="box03 progressItem progressItem6 activeProgress" style="margin-bottom: 0;display: none">
                <div class="xuhao" style="background: #999999;">2</div>
                <h1>驳回</h1>
                <h2 class="date"></h2>
                <div class="clearfix"></div>
                <h3>您的充电桩已经被驳回，请重新申请</h3>
            </div>
        </div>

        <div class="box04">
            <h1>申请原因</h1>
            <textarea id="reasonBox" disabled>加载中...</textarea>
            <div class="clearfix"></div>
        </div>
        <div class="box04">
            <h1>审核信息</h1>
            <textarea id="reasonByAdminBox" disabled>加载中...</textarea>
            <div class="clearfix"></div>
        </div>
        <div class="conbox03">
            <div class="box05">
                <h1>充电桩桩号(<span id="realCount">0</span>)</h1>
                <h2>状态</h2>
                <div class="clearfix"></div>
            </div>

            <div class="cdzList">
                <p style="text-align: center;padding: 10px">暂未配货</p>
            </div>

        </div>
    </div>
</div>


    <script type="text/html" id="cdzInfoTmpl">
        <div class="box05">
            <h1>{{code}}</h1>
            <h2>{{status}}</h2>
            <div class="clearfix"></div>
        </div>
    </script>

    <script type="application/javascript">

        var id = getQueryString("id");

        if(!vaildeParam(id)){
            layer.msg("非法操作");
            clicked('list.html');
        }


        var ws=null;
        var uuid = null;

        var topoffset=0;
        var ms=(/Html5Plus\/.+\s\(.*(Immersed\/(\d+\.?\d*).*)\)/gi).exec(navigator.userAgent);
        if(ms&&ms.length>=3){
            topoffset=parseFloat(ms[2]);
        }


        if(window.plus){
            pagePlusReady();
        }else{
            document.addEventListener('plusready',pagePlusReady,false);
        }

        function pagePlusReady() {

            uuid = plus.storage.getItem("uuid");

            getData();

            ws=plus.webview.currentWebview();
            if(plus.navigator.isImmersedStatusbar()){// 兼容沉浸式状态栏模式
                topoffset=Math.round(plus.navigator.getStatusbarHeight());
            }
            ws.setPullToRefresh({support:true,style:'circle',offset:topoffset+45+'px'},onRefresh);
        }


        // 刷新页面
        function onRefresh(){

            getData();

            ws.endPullToRefresh();
        }


        /**
         * 获取数据
         */
        function getData() {

            var data = {
                'uuid':uuid,
                'id':id
            }

            postJSON(API_URL.ApiApplyCdzDetail,data,function (res) {

                if('0' == res.code){

                    var data = res.data;

                    if(data.status == '已发货'){
                        $("#confirmGetBtn").css("display",'block')
                    }else{
                        $("#confirmGetBtn").css("display",'none')
                    }

                    showStatus(data);

                    $("#reasonBox").html(vaildeParam(data.reason)?data.reason:'暂无');
                    $("#reasonByAdminBox").html(vaildeParam(data.reasonByAdmin)?data.reasonByAdmin:'暂无');
                    $("#realCount").html(data.realCount);

                    showCdz(data);
                }else{
                    layer.msg(res.msg)
                }

            })

        }

        /**
         * 申请已提交,
         * 审核通过
         * 待发货
         * 已发货
         * 已收货
         *
         * @param data
         */
        function showStatus(data) {

            console.log(data.status)

            if(data.status == '申请已提交'
                || data.status == '审核通过'
                || data.status == '待发货'
                || data.status == '已发货'
                || data.status == '已收货'
                || data.status == '驳回'
            ){
                $(".progressItem1 .date").text(new Date(data.submitDate).format("yyyy-MM-dd hh:mm:ss"))
                $(".progressItem1").addClass('activeProgress');
            }

            if(data.status == '待发货'
                || data.status == '已发货'
                || data.status == '已收货'
            ){
                $(".progressItem2 .date").text(new Date(data.checkDate).format("yyyy-MM-dd hh:mm:ss"))
                $(".progressItem2").addClass('activeProgress');
                $(".progressItem3 .date").text(new Date(data.checkDate).format("yyyy-MM-dd hh:mm:ss"))
                $(".progressItem3").addClass('activeProgress');
            }

            if(data.status == '已发货'
                || data.status == '已收货'
            ){
                $(".progressItem4 .date").text(new Date(data.transDate).format("yyyy-MM-dd hh:mm:ss"))
                $(".progressItem4").addClass('activeProgress');
            }

            if(data.status == '已收货'){
                $(".progressItem5 .date").text(new Date(data.getDate).format("yyyy-MM-dd hh:mm:ss"))
                $(".progressItem5").addClass('activeProgress');
            }

            if(data.status == '驳回'){
                $(".progressItem2").css("display","none");
                $(".progressItem3").css("display","none");
                $(".progressItem4").css("display","none");
                $(".progressItem5").css("display","none");
                $(".progressItem6").css("display","block");
                $(".progressItem6 .date").text(new Date(data.checkDate).format("yyyy-MM-dd hh:mm:ss"))

            }else{
                $(".progressItem6").css("display","none");
            }

        }
        
        
        function showCdz(data) {

            var applyCdzDataItemList = data.applyCdzDataItemList;

            if(applyCdzDataItemList.length==0){
                return;
            }

            var $cdzList = $(".cdzList");

            var cdzInfoTmpl = $("#cdzInfoTmpl").html();

            var html = '';

            $.each(applyCdzDataItemList,function (index,item) {

                var code = item.shellId;
                var groupId = item.charging.groupId;

                var status = '未安装';
                if(null != groupId){
                    status = '已安装';
                }

                html += cdzInfoTmpl.replace(/{{code}}/g,code)
                    .replace(/{{status}}/g,status)

            })

            $cdzList.html(html);


        }

        $("#confirmGetBtn").click(function () {

            var data = {
                'uuid':uuid,
                'id':id
            }

            postJSON(API_URL.ApiApplyCdzConfirmGet,data,function (res) {

                if('0' == res.code){

                    layer.msg("操作成功");

                    getData();

                }else{
                    layer.msg(res.msg);
                }

            })
        })

        
    </script>
</body>
</html>