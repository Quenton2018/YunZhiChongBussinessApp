<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>片区申请</title>
	<link rel="stylesheet" href="../css/mui.min.css">
	<link rel="stylesheet" href="../css/iconfont.css">
	<link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
	<link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
	<script src="../js/jquery-3.3.1.min.js"></script>
	<script src="../js/bootstrap.min.js"></script>
	<script src="../plugins/layer/layer.js"></script>
	<script src="../js/hammer.min.js"></script>
	<script src="../js/jquery.hammer.js"></script>
	<script src="../js/common.js"></script>
	<script src="../js/base.js"></script>
    <script src="../js/mui.min.js"></script>
    <style type="text/css">
        .topAlertIfo{
            font-size: .8rem;
            padding: 15px;
            background-color: #FF7546;
        }
        .topInfo{
            font-size: 1rem;
            padding: 15px;
        }
        .mui-content{
            background-color: #ffffff;
        }
        .application-Box{
            overflow: hidden;
            margin-bottom: 0;
            margin: 15px;
            padding-top: 1rem;
        }
        .application-Box .inputBox{
            position: relative;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        .application-Box .inputBox i{
            font-size: 1rem;
            position: absolute;
            left: 10px;
            line-height: 2.5rem;
            color: #000;
        }
        .application-Box input{
            display: block;
            border: none;
            background: #F0F1F3;
            padding-left: 80px;
            border-radius: 20px;
            font-size: .9rem;
        }
        .application-Box input:focus{
            outline: none;
        }
        .getCode{
            position: absolute;
            right: 10px;
            top: 0;
            color: #333;
            font-size: .8rem;
            height: 40px;
            line-height: 40px;
            padding: 0 10px;
        }

        #submitBtn{
            display: block;
            width: 100%;
            position: fixed;
            bottom: 0;
            background-color: #FF7546;
            height: 60px;
            color: #ffff;
            border: none;
            border-radius: 0;
        }

    .btn-class{
        width: 50%;
        margin: 0 auto;
        text-align: center;
        margin-top: 10px;
    }

        .mui-input-row .mui-numbox {
            /* float: right; */
            margin: 2px 8px;
            float: left;
            margin-left: 0px;
            width: 160px;
        }

        .mui-input-group:before{
            background-color:transparent;
        }
        .mui-input-group:after{
            background-color:transparent;
        }

        .mui-input-group .mui-input-row:last-child:after{
            background-color:transparent;
        }
        .memberItem{
            display: block;
            margin: 10px;
            box-shadow: 0 1px 6px #ccc;
            padding: 10px;
            position: relative;
        }
        .deleteBtn{
            display: block;
            position: absolute;
            right: 0px;
            top: 0px;
            padding: 10px;
            z-index: 999;
        }
    </style>

</head>
<body style="background: #fff">

    <header class="mui-bar mui-bar-nav">
        <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
        <h1 class="mui-title">合伙人设置</h1>
    </header>

    <div class="mui-content" style="background: #fff;    padding-bottom: 100px;">
        <div class="topAlertIfo">
            请正确填写信息 合伙人手机为平台账号 比例为合伙人分成比例百分比
        </div>

        <div  id="dataList">
            <h1 class="topInfo">
                合伙人信息
            </h1>
            <form class="mui-input-group memberItem">

               <!-- <i class="deleteBtn iconfont icon-shanchu" onclick="deleteFrom(this)"></i>-->

                <div class="mui-input-row">
                    <label>合伙人姓名</label>
                    <input type="text" class="mui-input-clear companyName" name="users"  disabled="true" placeholder="请输入合伙人姓名">
                </div>
                <div class="mui-input-row">
                    <label>合伙人手机</label>
                    <input type="text" class="mui-input-clear companyMobile" name="mobile" disabled="true"   placeholder="请输入合伙人手机">
                </div>
                <div class="mui-input-row">
                    <label>第一年比例</label>
                    <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                        <!-- "-"按钮，点击可减小当前数值 -->
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number"  name="rate1" value="10" />
                        <!-- "+"按钮，点击可增大当前数值 -->
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                </div>
                <div class="mui-input-row">
                    <label>第二年比例</label>
                    <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                        <!-- "-"按钮，点击可减小当前数值 -->
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number"  name="rate2" value="20"/>
                        <!-- "+"按钮，点击可增大当前数值 -->
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                </div>
            </form>
            <form class="mui-input-group memberItem">
                <!-- <i class="deleteBtn iconfont icon-shanchu" onclick="deleteFrom(this)"></i>-->
                <div class="mui-input-row">
                    <label>合伙人姓名</label>
                    <input type="text" class="mui-input-clear username" name="users" value=""  disabled="true" placeholder="请输入合伙人姓名">
                </div>
                <div class="mui-input-row">
                    <label>合伙人手机</label>
                    <input type="text" class="mui-input-clear usersmobile" name="mobile"  value="" disabled="true" placeholder="请输入合伙人手机">
                </div>
                <div class="mui-input-row">
                    <label>第一年比例</label>
                    <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                        <!-- "-"按钮，点击可减小当前数值 -->
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number"  name="rate1" value="90" />
                        <!-- "+"按钮，点击可增大当前数值 -->
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                </div>
                <div class="mui-input-row">
                    <label>第二年比例</label>
                    <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                        <!-- "-"按钮，点击可减小当前数值 -->
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number"  name="rate2" value="80" />
                        <!-- "+"按钮，点击可增大当前数值 -->
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                </div>
            </form>
        </div>
        <div class="btn-class">
            <button type="button" class="mui-btn mui-btn-success addHeHuoRen">新增一个合伙人</button>
        </div>

        <button id="submitBtn">
                下一步
        </button>
    </div>
    <script type="text/html" id="heHuoRenTmpl">
            <form class="mui-input-group memberItem">

                <i class="deleteBtn iconfont icon-shanchu" onclick="deleteFrom(this)"></i>

                <div class="mui-input-row ">
                    <label>合伙人姓名</label>
                    <input type="text" class="mui-input-clear" name="users" placeholder="请输入合伙人姓名">
                </div>
                <div class="mui-input-row">
                    <label>合伙人手机</label>
                    <input type="text" class="mui-input-clear" name="mobile" placeholder="合伙人手机为平台账号">
                </div>
                <div class="mui-input-row">
                    <label>第一年比例</label>
                    <div class="mui-numbox"  data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                        <!-- "-"按钮，点击可减小当前数值 -->
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number"  value="0" name="rate1" />
                        <!-- "+"按钮，点击可增大当前数值 -->
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                </div>
                <div class="mui-input-row">
                    <label>第二年比例</label>
                    <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                        <!-- "-"按钮，点击可减小当前数值 -->
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number" value="0"  name="rate2" />
                        <!-- "+"按钮，点击可增大当前数值 -->
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                </div>
            </form>
    </script>


	<script type="text/javascript">
        mui.init();

        if(window.plus){
            pagePlusReady();
        }else{
            document.addEventListener('plusready',pagePlusReady,false);
        }
        function pagePlusReady(){
            GetCompanyAccount();
            getUserInfoDateBase();

            $("#submitBtn").click(function(){ //下一步
                    //服务校验参数 然后保存
                    var uuid = plus.storage.getItem("uuid");
                    var app_name = plus.storage.getItem("app_name");
                    var app_address = plus.storage.getItem("app_address");
                    var app_latitude = plus.storage.getItem("app_latitude");
                    var app_longitude = plus.storage.getItem("app_longitude");
                    var app_electricPrice = plus.storage.getItem("app_electricPrice");
                    console.log("uuid======"+uuid);
                    console.log("app_name======"+app_name);
                    console.log("app_address======"+app_address);
                    console.log("app_latitude======"+app_latitude);
                    console.log("app_longitude======"+app_longitude);
                    console.log("app_electricPrice======"+app_electricPrice);

                var $memberItem = $(".memberItem");
                var memberList = new Array();
                var memberListJson = '';

                var reg = /^-?[1-9]+(\.\d+)?$|^-?0(\.\d+)?$|^-?[1-9]+[0-9]*(\.\d+)?$/;
                var rateSum1 = 0;
                var rateSum2 = 0;
                var flag= false;
                var flagMobile= false;
                var flagMobileNumber= false;
                $.each($memberItem,function (index,item) {
                    var users =  $(item).find( $("input[name='users']")).val();
                    var mobile =  $(item).find( $("input[name='mobile']")).val();
                    var rate1 =  $(item).find( $("input[name='rate1']")).val();
                    var rate2 =  $(item).find( $("input[name='rate2']")).val();
                    if(!vaildeParam(mobile) || !vaildeParam(users) || !vaildeParam(rate1) || !vaildeParam(rate2)){
                        flag = true;
                        return;
                    }
                    //校验是数字
                    if(!reg.test(mobile)){
                        flagMobileNumber = true;
                        return;
                    }
                    if(mobile.length!==11){
                        flagMobile = true;
                        return;
                    }

                    rateSum1 =parseInt(rateSum1)+parseInt(rate1);
                    rateSum2 = parseInt(rateSum2)+parseInt(rate2);
                    var member = new Object();
                    member.users = users;
                    member.mobile = mobile;
                    member.rate1 = rate1;
                    member.rate2 = rate2;
                    memberList.push(member);
                })
                console.log("rateSum1:"+rateSum1);
                console.log("rateSum2:"+rateSum2);
                if(flag){
                    layer.msg("请补全信息");
                    return;
                }
                if(flagMobile){
                    layer.msg("合伙人手机必须为11位");
                    return;
                }
                if(flagMobileNumber){
                    layer.msg("合伙人手机必须为数字");
                    return;
                }
                if(rateSum1!=100){
                    layer.msg("合伙人第一年比例相加必须为100%");
                    return;
                }
                if(rateSum2 !=100){
                    layer.msg("合伙人第二年比例相加必须为100%");
                    return;
                }

                memberListJson = JSON.stringify(memberList);
                console.log("memberListJson"+memberListJson);
                plus.storage.setItem( "memberListJson", memberListJson);
                clicked('electricityPrice.html');  //下一步

            });
        }
        /**
         * 添加一个合伙人
         */
        $(".addHeHuoRen").click(function () {
            var tmpl = $("#heHuoRenTmpl").html();
            $("#dataList").append(tmpl);
            mui('.mui-numbox').numbox()
        })
        /**
         * @param that
         */
        function deleteFrom(that) {
            var $this = $(that);
            layer.confirm("是否确定删除",function (index) {
                $this.parents(".mui-input-group").remove();
                layer.close(index)
            })
        }

        function GetCompanyAccount(){
            var uuid = plus.storage.getItem("uuid");
            console.log("## GetCompanyAccount ## uuid:"+uuid);
            if(vaildeParam(uuid)){
                postJSON(API_URL.ApiAdminGetCompanyAccount,{"uuid":uuid},function(res){
                    if("0" == res.code){
                        var mobile = res.data.username;
                        var nickname = res.data.realname;
                        $(".companyName").val(nickname);
                        $(".companyMobile").val(mobile);
                    }else{
                        layer.msg(res.msg);
                        clearLogin();
                        clicked("page/login.html");
                    }
                })
            }
        }

        /**
         * 获取用户信息
         */
        function getUserInfoDateBase(){
            var uuid = plus.storage.getItem("uuid");
            console.log("## getUserInfoDateBase ## uuid:"+uuid);
            if(vaildeParam(uuid)){
                postJSON(API_URL.ApiAdminInfo,{"uuid":uuid},function(res){
                    if("0" == res.code){
                        var mobile = res.data.username;
                        var nickname = res.data.realname;
                      /*  plus.storage.setItem( "mobile", mobile);
                        plus.storage.setItem( "nickname", nickname);*/
                        $(".username").val(nickname);
                        $(".usersmobile").val(mobile);
                    }else{
                        layer.msg(res.msg);
                        clearLogin();
                        clicked("page/login.html");
                    }
                })
            }
        }


    </script>
</body>
</html>