<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>我的充电桩</title>
    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/hammer.min.js"></script>
    <script src="../js/jquery.hammer.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/mui.min.js"></script>
    <style type="text/css">
        .topInfoBox{
            text-align: center;
            padding-top: 10px;
        }
        .topInfoBox h1{
            color: #F17E38;
            font-size: 4rem;
            font-weight: 400;
        }
        .topInfoBox small{
            font-size: .8rem;
            color: #9D9D9D;
        }

        .tabBox{
            text-align: center;
            padding-top: 20px;
        }
        .tabBox span{
            display: inline-block;
            padding: 5px 10px;
            font-size: .8rem;
        }
        .tabBox span.select{
            border-bottom: #EC8131 solid 2px;
        }
        .midRow{
            background: #F0F1F3;
            padding: 10px 15px;
            font-size: .8rem;
            color: #979797;
        }

        .mui-table-view{
            font-size: .9rem;
        }
        .mui-table-view .mui-badge{
            background: transparent;
            font-size: .9rem;
        }

        #loadMore{
            background: #eaeaea;
            margin-top: 10px;
            padding: 10px;
            text-align: center;
            margin-top: 10px;
            font-size: .8rem;
            display: none;
        }
        .noMore{
            margin-top: 10px;
            padding: 10px;
            text-align: center;
            margin-top: 10px;
            font-size: .8rem;
            display: none;
        }


    </style>

</head>
<body style="background: #fff">

<header class="mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">我的充电桩</h1>
</header>

<div class="mui-content" style="background: #fff">

    <div class="topInfoBox">
        <h1 id="countAll">0</h1>
        <small>我的充电桩总数(台)</small>
    </div>

    <div class="tabBox">
        <span id="normal" class="tabItem select" data-type="1">正常充电桩(<span id="countValid">0</span>)</span>
        <span id="abnormal"  class="tabItem " data-type="2">异常充电桩(<span id="countInvalid">0</span>)</span>
    </div>

    <div class="midRow">
        <div class="left">片区(<span id="groupCount">0</span>)</div>
        <div class="right">月收入(<span>元</span>)</div>
        <div class="clearfix"></div>
    </div>
    <div  class="normal" >
        <ul class="mui-table-view dataList">

        </ul>
        <div id="loadMore" class="loadMore">加载更多</div>
        <div id="noMore" class="noMore">没有更多了</div>
    </div>

</div>


<script type="text/html" id="dataTmpl">
    <li class="mui-table-view-cell">
        <a class="mui-navigate-right" onclick="clicked('areaDataXinxi.html?id={{id}}')" data-id="{{id}}">
            <span class="mui-badge moneyBox" data-id="{{id}}">{{money}}</span>
            {{groupName}}-{{sn}}
        </a>
    </li>
</script>
<script type="text/html" id="dataTmpl2">
    <li class="mui-table-view-cell">
        <a class="mui-navigate-right" onclick="clicked('areaListUnNormal.html?id={{id}}')" data-id="{{id}}">
            <span class="mui-badge moneyBox" data-id="{{id}}">{{money}}</span>
            片区名称:{{groupName}}
        </a>
    </li>
</script>





<script type="text/javascript">
    mui.init();

    var btnType ="0";  //正常：0 异常：1
    var pageNumber = 1;
    var pageSize = 10;
    var type = 1;
    var uuid = '';

    if(window.plus){
        pagePlusReady();
    }else{
        document.addEventListener('plusready',pagePlusReady,false);
    }
    function pagePlusReady(){
        checkLogin();

        uuid = plus.storage.getItem("uuid");

        // uuid = '568f792a6bd34604a3ff666d6ac43f39';

        getChargingCountByPartner(uuid);

        getChargingGroup(uuid);
    }


    /**
     * 获取充电桩数量
     */
    function getChargingCountByPartner(uuid){
        var param = {
            'uuid':uuid
        }
        postJSON(API_URL.ApiChargingGetChargingCountByPartner,param,function(res){
            if("0" == res.code){
                $("#countAll").text(res.data.countAll);
                $("#countValid").text(res.data.countValid);
                $("#countInvalid").text(res.data.countInvalid);
            }else{
                layer.msg(res.msg);
            }
        })
    }


    $(".tabItem").click(function(){

        type = $(this).attr("data-type");

        $(".tabItem").removeClass('select');
        $(this).addClass("select");

        pageNumber = 1;

        getChargingGroup(uuid);

    });



    /**
     抓取数据
     */
    function getChargingGroup(uuid){

        var dataParam= {
            "uuid":uuid,
            "pageSize":pageSize,
            "pageNumber":pageNumber,
            "type":type
        }

        postJSON(API_URL.ApiGetChargingGroup,dataParam,function(res){
            if("0" == res.code){
                if(1 == pageNumber){
                    $(".dataList").html('');
                }
                var data = res.data;
                if(vaildeParam(data)){
                    $("#groupCount").text(data.length);
                }
                var html = '';
                var tmpl = $("#dataTmpl").html();
                if(2 == type){
                    var tmpl = $("#dataTmpl2").html();
                }
                var ids = '';
                var falgLast = true;
                $.each(data, function(index,item) {
                    var createDate = new Date(item.createDate).format("yyyy-MM-dd hh:mm:ss");
                    html += tmpl.replace(/{{createDate}}/g,createDate)
                        .replace(/{{groupName}}/g,item.name)
                        .replace(/{{sn}}/g,item.sn)
                        .replace(/{{id}}/g,item.id)
                        .replace(/{{money}}/g,'<img src="../images/5-121204194028.gif" height="15">');
                    ids += item.id+",";
                    if(index<9){
                        falgLast =true;
                    }else{
                        falgLast =false;
                    }
                });

                console.log("ids:"+ids)

                $(".dataList").append(html);

                getItemMoney(ids,uuid);
                if(falgLast){
                    $("#loadMore").css({"display":"none"});
                    $("#noMore").css({"display":"block"});
                }else{
                    $("#loadMore").css({"display":"block"});
                    $("#noMore").css({"display":"none"});
                }

            }else{
                layer.msg(res.msg);
            }
        })
    }

    function getItemMoney(ids,uuid){

        if(!vaildeParam(ids)){
            return;
        }

        var idsArr = ids.split(",");

        $.each(idsArr,function (index,item) {

            if(vaildeParam(item)){

                var startDate = getCurrentMonthFirst().format("yyyy-MM-dd") + ' 00:00:00';
                var endDate = getCurrentMonthLast().format("yyyy-MM-dd") + ' 23:59:59';

                var param = {
                    'uuid':uuid,
                    'groupID':item,
                    'startDate':startDate,
                    'endDate':endDate
                }

                postJSON(API_URL.ApiGetSumMoney,param,function (res) {

                    if("0" == res.code){
                        $(".moneyBox[data-id='"+item+"']").text(res.data);
                    }

                })

            }

        })

    }


    $("#loadMore").click(function(){
        pageNumber++;
        getChargingGroup(uuid);
    })


</script>
</body>

</html>