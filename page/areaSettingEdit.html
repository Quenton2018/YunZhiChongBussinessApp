<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>片区申请</title>
    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/hammer.min.js"></script>
    <script src="../js/jquery.hammer.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/mui.min.js"></script>
    <style type="text/css">
        *{margin:0;padding:0;text-decoration:none;list-style:none;font-weight:normal;border-style:none;}
        body{background:#ececec;}
        .top{width:100%;height:44px;background:white;font-size:16px;color:white;text-align:center;line-height:44px;box-shadow:none;}
        .top .left{float:left;padding-left:30px;background:url("../images/pianqushenqing/faihui@3x.png") 15px center no-repeat;background-size:15px 22px;height:44px;}
        .top h1{z-index:-100;margin:0;padding:0;color:black;}
        .conbox01{margin-top:44px;}
        .box01{background:#e0e0e0;}
        .box01 .zhuangtai{text-align:center;float:left;width:calc(100% / 3);color:#999999;font-size:15px;line-height:35px;position:relative;}
        .zhuangtai .zhuanjiao{position:absolute;top:0;left:100%;width:0;height:0;border-left:12px solid #ff6d22;border-right:12px solid transparent;border-top:18.5px solid transparent;border-bottom:18.5px solid transparent;}
        .zhuangtai img{margin-top:10px;width:15px;height:15px;vertical-align:center;}
        .box02{line-height:36px;font-size:12px;color:#6a6a6a;margin-left:15px;}
        .box03{margin:0 10px;padding:0 10px;padding-top:15px;background:white;border-radius:10px;box-shadow:0px 0px 20px 0px rgba(238,238,238,0.004);margin-bottom:20px;}
        .box03 .line01{border-bottom:1px solid #dce1e6;}
        .line01 .biaozhu{background:#ff6d22;width:4px;height:12px;float:left;margin-right:6px;border-radius:2px;margin-top:1.5px;margin-bottom:15px;}
        .line01 h1{float:left;margin:0;padding:0;font-size:15px;line-height:15px;font-weight:bolder;margin-bottom:15px;}
        .line01 .shanchu{float:right;margin-bottom:15px;}
        .box03 .line02{border-bottom:1px solid #dce1e6;}
        .line02 h1{float:left;margin:0;padding:0;font-size:15px;line-height:15px;margin-top:15px;margin-bottom:15px;width:50%;}
        .line02 input{width:50%;float:right;margin:0;padding:0;font-size:15px;line-height:15px;text-align:right;border:none;}
        .box03 .line03{border-bottom:1px solid #dce1e6;}
        .line03 h1{float:left;margin:0;padding:0;font-size:15px;line-height:15px;margin-top:15px;margin-bottom:15px;width:50%;}
        .line03 .bilibox{float:right;margin-top:7.5px;}
        .bilibox .jian{text-align:center;float:left;border-radius:2px 0 0 2px;width:33px;height:30px;background-color:rgb(247,247,247);border:1px solid rgb(186,185,192);}
        .jian img{margin-top:14px;}
        .bilibox .shuliang{text-align:center;font-size:15px;color:black;line-height:30px;float:left;width:33px;height:30px;background-color:#f0f1f3;border-top:1px solid rgb(186,185,192);border-bottom:1px solid rgb(186,185,192);}
        .bilibox .jia{text-align:center;float:left;border-radius:0 2px 2px 0;width:33px;height:30px;background-color:rgb(247,247,247);border:1px solid rgb(186,185,192);border-bottom:1px solid rgb(186,185,192);}
        .jia img{margin-top:9px;}
        .xinzengbox{width:60%;font-size:15px;line-height:45px;text-align:center;border:1px dashed #bab9c0;margin:0 auto;margin-bottom:70px;border-radius:10px;}
        .xinzengbox img{position:relative;top:2px;width:16px;height:16px;}
        .dbbt{background-image:-moz-linear-gradient(135deg,rgb(240,130,0) 0%,rgb(255,117,70) 100%);background-image:-webkit-linear-gradient(135deg,rgb(240,130,0) 0%,rgb(255,117,70) 100%);background-image:-ms-linear-gradient(135deg,rgb(240,130,0) 0%,rgb(255,117,70) 100%);height:49px;text-align:center;color:white;font-size:16px;line-height:49px;box-shadow:none;}
        .mui-numbox{position:relative;display:inline-block;overflow:hidden;width:120px;height:30px;padding:0 40px;vertical-align:top;vertical-align:middle;border:solid 1px #bbb;border-radius:3px;background-color:#efeff4;}
    </style>

</head>
<body>
<header class="header header-immersed mui-bar mui-bar-nav">
    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
    <h1 class="mui-title">申请片区修改</h1>
</header>

<div class="mui-content">
    <div class="box01" style="margin-top: 20px;">
        <div class="zhuangtai" style="background: #ff6d22;color:#ffcaaf;">
            <img src="../images/pianqushenqing/pianqumingchen02.png">
            片区申请
        </div>
        <div class="zhuangtai"style="background: #ff6d22;color: white">
            <div class="zhuanjiao"></div>
            <img src="../images/pianqushenqing/hehuoren02@3x.png">
            合伙人设置
        </div>
        <div class="zhuangtai">
            <img src="../images/pianqushenqing/dianjia@3x.png">
            电价设置
        </div>
        <div class="clearfix"></div>
    </div>
    <div class="box02">
        合伙人手机为平台账号，比例为合伙人分成比例百分比
    </div>
    <div  id="dataList">


    </div>
    <div class="xinzengbox addHeHuoRen">
        <img src="../images/pianqushenqing/xinzeng.png">
        新增一个合伙人
    </div>
</div>

<div class="dbbt mui-bar mui-bar-tab" id="submitBtn">
    下一步
</div>

<script type="text/html" id="heHuoRenTmpl">
    <div class="box03 memberItem">
        <div class="line01">
            <div class="biaozhu"></div>
            <h1>合伙人信息</h1>
            <div class="shanchu" onclick="deleteFrom(this)">
                <img src="../images/pianqushenqing/guanbi@3x.png"style="width: 15px;height: 15px;">
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="line02">
            <h1>合伙人姓名</h1>
            <input type="text" placeholder="请填写姓名"  name="users" />
            <div class="clearfix"></div>
        </div>
        <div class="line02">
            <h1>合伙人手机</h1>
            <input type="text" placeholder="请填写电话号码" name="mobile" />
            <div class="clearfix"></div>
        </div>
        <div class="line03">
            <h1>第一年比例</h1>
            <div class="bilibox">
                <div class="mui-numbox"  data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                    <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                    <input class="mui-numbox-input" type="number"  value="0" name="rate1" />
                    <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="line03" style="border: none;">
            <h1>第二年比例</h1>
            <div class="bilibox">
                <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                    <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                    <input class="mui-numbox-input" type="number" value="0"  name="rate2" />
                    <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</script>


<script type="text/html" id="heHuoRenTmplTwo">
    <div class="box03 memberItem">
        <div class="line01">
            <div class="biaozhu"></div>
            <h1>合伙人信息</h1>
            <div class="clearfix"></div>
        </div>
        <div class="line02">
            <h1>合伙人姓名</h1>
            <input type="text" placeholder="请填写姓名"  name="users"  value="{{users}}"  disabled="true"/>
            <div class="clearfix"></div>
        </div>
        <div class="line02">
            <h1>合伙人手机</h1>
            <input type="text" placeholder="请填写电话号码" name="mobile"  value="{{mobile}}"  disabled="true"/>
            <div class="clearfix"></div>
        </div>
        <div class="line03">
            <h1>第一年比例</h1>
            <div class="bilibox">
                <div class="mui-numbox"  data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                    <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                    <input class="mui-numbox-input" type="number" value="{{rate1}}" name="rate1" />
                    <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                </div>
            </div>
            <div class="clearfix"></div>
        </div>
        <div class="line03" style="border: none;">
            <h1>第二年比例</h1>
            <div class="bilibox">
                <div class="mui-numbox" data-numbox-step='10' data-numbox-min='0' data-numbox-max='100'>
                    <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                    <input class="mui-numbox-input" type="number" value="{{rate2}}"  name="rate2" />
                    <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                </div>
                <div class="clearfix"></div>
            </div>
            <div class="clearfix"></div>
        </div>
    </div>
</script>


<script type="text/javascript">
    mui.init();

    $.plusReady(function() {
    	var  memberListJson =  plus.storage.getItem( "memberListJson");
        var memberListJsonObj =  JSON.parse(memberListJson);

        var tmpl = $("#heHuoRenTmplTwo").html();
        var html = '';
        for(var i=0;i<memberListJsonObj.length;i++){
            var users =memberListJsonObj[i].users;
            var mobile =memberListJsonObj[i].mobile;
            var rate1 =memberListJsonObj[i].rate1;
            var rate2 =memberListJsonObj[i].rate2;
            html += tmpl.replace(/{{users}}/g,users)
                .replace(/{{mobile}}/g,mobile)
                .replace(/{{rate1}}/g,rate1)
                .replace(/{{rate2}}/g,rate2);
        }
        $("#dataList").append(html);
        mui('.mui-numbox').numbox();

        console.log("memberListJsonObj:"+memberListJsonObj);



        $("#submitBtn").click(function(){ //下一步
            //服务校验参数 然后保存
            var uuid = plus.storage.getItem("uuid");
            var app_name = plus.storage.getItem("app_name");
            var app_address = plus.storage.getItem("app_address");
            var app_latitude = plus.storage.getItem("app_latitude");
            var app_longitude = plus.storage.getItem("app_longitude");
            var app_electricPrice = plus.storage.getItem("app_electricPrice");
            console.log("uuid======"+uuid);
            console.log("app_name======"+app_name);
            console.log("app_address======"+app_address);
            console.log("app_latitude======"+app_latitude);
            console.log("app_longitude======"+app_longitude);
            console.log("app_electricPrice======"+app_electricPrice);

            var $memberItem = $(".memberItem");
            var memberList = new Array();

            var memberCheckArray = new Array();
            var memberListJson = '';

            var reg = /^-?[1-9]+(\.\d+)?$|^-?0(\.\d+)?$|^-?[1-9]+[0-9]*(\.\d+)?$/;
            var rateSum1 = 0;
            var rateSum2 = 0;
            var flag= false;
            var flagMobile= false;
            var flagMobileNumber= false;
            var flagMobileRepeat = false;
            var flagHehuoren = false;
            $.each($memberItem,function (index,item) {

                var users =  $(item).find( $("input[name='users']")).val();
                var mobile =  $(item).find( $("input[name='mobile']")).val();
                var rate1 =  $(item).find( $("input[name='rate1']")).val();
                var rate2 =  $(item).find( $("input[name='rate2']")).val();
                if(!vaildeParam(mobile) || !vaildeParam(users) || !vaildeParam(rate1) || !vaildeParam(rate2)){
                    flag = true;
                    return;
                }
                //校验是数字
                if(!reg.test(mobile)){
                    flagMobileNumber = true;
                    return;
                }
                if(mobile.length!==11){
                    flagMobile = true;
                    return;
                }
                rateSum1 =parseInt(rateSum1)+parseInt(rate1);
                rateSum2 = parseInt(rateSum2)+parseInt(rate2);

                //校验成员是否重复memberCheck
                if(isInArray(memberCheckArray,mobile)){
                    flagMobileRepeat = true;
                    return;
                }
                memberCheckArray.push(mobile); //将元素放入数组

                var member = new Object();
                member.users = users;
                member.mobile = mobile;
                member.rate1 = rate1;
                member.rate2 = rate2;
                memberList.push(member);
            });
            console.log("rateSum1:"+rateSum1);
            console.log("rateSum2:"+rateSum2);
            if(flag){
                layer.msg("请补全信息");
                return;
            }
            if(flagMobile){
                layer.msg("合伙人手机必须为11位");
                return;
            }
            if(flagMobileNumber){
                layer.msg("合伙人手机必须为数字");
                return;
            }
            if(rateSum1!=100){
                layer.msg("合伙人第一年比例相加必须为100%");
                return;
            }
            if(rateSum2 !=100){
                layer.msg("合伙人第二年比例相加必须为100%");
                return;
            }
            if(flagMobileRepeat){
                layer.msg("合伙人手机不能重复");
                return;
            }

            memberListJson = JSON.stringify(memberList);
            console.log("memberListJson"+memberListJson);
            plus.storage.setItem( "memberListJson", memberListJson);
            clicked('electricityPriceEdit.html');  //下一步

        });
    });




    /**
     * 使用indexOf判断元素是否存在于数组中
     * @param {Object} arr 数组
     * @param {Object} value 元素值
     */
    function isInArray(arr,value){
        if(arr.indexOf&&typeof(arr.indexOf)=='function'){
            var index = arr.indexOf(value);
            if(index >= 0){
                return true;
            }
        }
        return false;
    }


    var falgNumbers = 0;

    function updateFalgNumbers() {
        falgNumbers = $(".memberItem").length;
    }
    /**
     * 添加一个合伙人
     */
    $(".addHeHuoRen").click(function () {
        updateFalgNumbers();
        if(falgNumbers>4){
            layer.msg("合伙人最多5个人");
            return;
        }else {
            var tmpl = $("#heHuoRenTmpl").html();
            $("#dataList").append(tmpl);
            mui('.mui-numbox').numbox();
        }
    })

    /**
     * @param that
     */
    function deleteFrom(that) {
        var $this = $(that);
        layer.confirm("是否确定删除",function (index) {
            updateFalgNumbers();
            console.log("falgNumbers==="+falgNumbers);
            $this.parents(".memberItem").remove();
            layer.close(index);
        })
    }

    function GetCompanyAccount(){
        var uuid = plus.storage.getItem("uuid");
        console.log("## GetCompanyAccount ## uuid:"+uuid);
        if(vaildeParam(uuid)){
            postJSON(API_URL.ApiAdminGetCompanyAccount,{"uuid":uuid},function(res){
                if("0" == res.code){
                    var mobile = res.data.username;
                    var nickname = res.data.realname;
                    $(".companyName").val(nickname);
                    $(".companyMobile").val(mobile);
                }else{
                    layer.msg(res.msg);
                    clearLogin();
                    clicked("page/login.html");
                }
            })
        }
    }

    /**
     * 获取用户信息
     */
    function getUserInfoDateBase(){
        var uuid = plus.storage.getItem("uuid");
        console.log("## getUserInfoDateBase ## uuid:"+uuid);
        if(vaildeParam(uuid)){
            postJSON(API_URL.ApiAdminInfo,{"uuid":uuid},function(res){
                if("0" == res.code){
                    var mobile = res.data.username;
                    var nickname = res.data.realname;
                    /*  plus.storage.setItem( "mobile", mobile);
                      plus.storage.setItem( "nickname", nickname);*/
                    $(".username").val(nickname);
                    $(".usersmobile").val(mobile);
                }else{
                    layer.msg(res.msg);
                    clearLogin();
                    clicked("page/login.html");
                }
            })
        }
    }


</script>



</body>
</html>