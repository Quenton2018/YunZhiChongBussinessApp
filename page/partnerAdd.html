<!DOCTYPE html>
<html>
	<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>添加市场合伙人</title>
    <link rel="stylesheet" href="../css/mui.min.css">
    <link rel="stylesheet" href="../css/common.css" type="text/css" charset="utf-8"/>
    <link rel="stylesheet" href="../plugins/layer/theme/default/layer.css" type="text/css" charset="utf-8"/>
    <script src="../js/jquery-3.3.1.min.js"></script>
    <script src="../plugins/layer/layer.js"></script>
    <script src="../js/hammer.min.js"></script>
    <script src="../js/jquery.hammer.js"></script>
    <script src="../js/common.js"></script>
    <script src="../js/base.js"></script>
    <script src="../js/mui.min.js"></script>
    <script src="../js/vue.min.js"></script>
    <style type="text/css">	
    	.mui-input-group .mui-input-row {
		    height: 50px;
		}
		.mui-input-row label{
			line-height: 25px;
    		font-size: 14px;
    		padding: 14px 15px;
		}
		.mui-input-row input{
			line-height: 25px;
		    height: 50px;
		    font-size: 14px;
		}
		.form-title{
			font-size: 16px;
    		padding: 8px 15px;
    		font-weight: 400;   		
		}
		.form-title span{
			border-left: 4px solid #ff6d22;
			display: inline-block;
			padding-left: 5px;
		}
		.htBox{
			padding: 20px 15px;
			height: 150px;
			/*overflow: hidden;*/
			background: #fff;
			margin-bottom: 20px;
		}
		.img-item{
			width: 23%;
			height: 100%;
			margin-right: 2%;
			float: left;
			position: relative;
			text-align: center;
			/*display: none;*/
			border: 1px dashed #c4c4c4;
		}
		.img-item img{
			width: 100%;
			height: 100%;
		}
		.close-img{
			position: absolute;
			right: -10px;
			top: -10px;
			background: #ff0000;
			z-index: 10;
			color: #fff;
			font-size: 30px;
			border-radius: 50%;
			padding: 0px;
			display: none;
		}
		.mui-btn {
			padding: 6px 24px;
			float: right;
			border: 1px solid #ff6d22;
			background: #ff6d22;
		}
		.upload .mui-icon-camera{
			font-size: 40px;
			color: #C4C4C4;
			margin-top: 20px;
		}
		.upload-text{
			font-size: 14px;
			color: #C4C4C4;
			display: block;
		}
    </style>
</head>
<body background="#f0f1f3" >
	<header class="header mui-bar header-immersed mui-bar-nav">
	    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
	    <h1 class="mui-title">添加市场合伙人</h1>
	</header> 
	<footer class="mui-bar mui-bar-footer btn-submit">
		<span>提交审核</span>
	</footer>
	<div class="mui-content">
		<h2 class="form-title"><span>基本信息</span></h2>
		<form class="mui-input-group">
		    <div class="mui-input-row">
		        <label>姓名</label>
		    	<input type="text" class="mui-input-clear" placeholder="请输入姓名">
		    </div>
		    <div class="mui-input-row">
		        <label>手机号</label>
		        <input type="tel" class="mui-input-clear" placeholder="请输入手机号">
		    </div>
			<div class="mui-input-row">
		        <label>备注</label>
		    	<input type="text" class="mui-input-clear" placeholder="请输入备注">
		    </div>
		</form>
		<h2 class="form-title"><span>地区</span></h2>
		<form class="mui-input-group">
		    <div class="mui-input-row">
		        <label>城市</label>
		    	<input type="text" class="mui-input-clear" placeholder="请输入城市">
		    </div>
		</form>
		<h2 class="form-title"><span>费用</span></h2>
		<form class="mui-input-group">
		    <div class="mui-input-row">
		        <label>产品保证金</label>
		    	<input type="number" class="mui-input-clear" placeholder="请输入产品保证金" value="30000">
		    </div>
		    <div class="mui-input-row">
		        <label>产品运维费</label>
		    	<input type="number" class="mui-input-clear" placeholder="请输入产品运维费" value="3800">
		    </div>
		</form>
		<h2 class="form-title mui-clearfix">
			<span>上传合同</span>
			<!--<button type="button" class="mui-btn mui-btn-primary" id="upload">上传</button>-->
		</h2>
		<div class="htBox mui-clearfix">
			<!--<div class="img-item">
				<img src="" id="htImg">
				<i class="close-img mui-icon mui-icon-closeempty"></i>
			</div>-->
			<div class="img-item upload">		
				<i class="mui-icon mui-icon-camera"></i>
				<span class="upload-text">上传图片</span>
			</div>
		</div>
	</div>
	    
<script type="text/javascript">
	mui.init();
	mui.plusReady(function() {
		/*点击上传按钮触发*/
	    mui('.mui-content').on('tap', '.upload',function() {
	        if(mui.os.plus) {
	            var a = [{
	                title: "立即拍照上传"
	            }, {
	                title: "从相册中选择"
	            }];
	            plus.nativeUI.actionSheet({
	                title: "上传合同照片",
	                cancel: "取消",
	                buttons: a
	            }, function(b) { /*actionSheet 按钮点击事件*/
	                switch(b.index) {
	                    case 0:
	                        break;
	                    case 1:
	                        getImage(); /*拍照*/
	                        break;
	                    case 2:
	                        galleryImg(); /*打开相册*/
	                        break;
	                    default:
	                        break;
	                }
	            })
	        }
	    }, false);
	
	    //拍照
	    function getImage() {
	        var cmr = plus.camera.getCamera();
	        var res = cmr.supportedImageResolutions[0];
	        var fmt = cmr.supportedImageFormats[0];
	        cmr.captureImage(function(path) {
	            //plus.io.resolveLocalFileSystemURL(path, function(entry) {
	            plus.io.resolveLocalFileSystemURL(path, function(entry) {
	                var localUrl = entry.toLocalURL();
	                uploadHead(localUrl + "?version=" + new Date().getTime());
	            }, function(err) {
	                console.error("拍照失败：" + err.message);
	            }, {
	                index: 1
	            });
	        });
	    }
	
	    //本地相册选择
	    function galleryImg() {
	        plus.gallery.pick(function(a) {
	            plus.io.resolveLocalFileSystemURL(a, function(entry) {
	                plus.io.resolveLocalFileSystemURL("_doc/", function(root) {
	                    root.getFile("ht.png", {}, function(file) {
	                        //文件已存在
	                        file.remove(function() {
	                            console.log("file remove success");
	                            entry.copyTo(root, 'ht.png', function(e) {
	                                var e = e.fullPath + "?version=" + new Date().getTime();
	                                uploadHead(e); /*上传图片*/
	                                //变更大图预览的src
	                                //目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现
	                            },function(e) {
	                                console.log('copy image fail:' + e.message);
	                            });
	                        }, function() {
	                            console.log("delete image fail:" + e.message);
	                        });
	                    }, function() {
	                        //文件不存在
	                        entry.copyTo(root, 'ht.png', function(e) {
	                            var path = e.fullPath + "?version=" + new Date().getTime();
	                            uploadHead(path); /*上传图片*/
	                        },function(e) {
	                            console.log('copy image fail:' + e.message);
	                        });
	                    });
	                }, function(e) {
	                    console.log("get _www folder fail");
	                })
	            }, function(e) {
	                console.log("读取拍照文件错误：" + e.message);
	            });
	        }, function(a) {}, {
	            filter: "image"
	        })
	    };
	
	    //上传头像图片
	    function uploadHead(imgPath) {
	        var uid = Storage.getItem("uuid");
	        var image = new Image();
	        console.log("dengwenwuimguid"+uid);
	        image.src = imgPath;
	        image.onload = function() {
	            var imgData = getBase64Image(image);
	//          console.log("imgData"+imgData);
	            /*在这里调用上传接口*/
	            mui.ajax(API_URL.ApiAdminUploadPicture, {
	                data: { 
	                	img: imgData,
	                	uuid:uid 
	                },
	                dataType: 'json',
	                type: 'post',
	                timeout: 10000,
	                success: function(data) {
	                    if("0" == data.code){
	                        var retUrl = data.data;
//	                        console.log("dengwenwuimgRetUrl"+retUrl);
//	                        console.log("dengwenwuimgPath"+imgPath);
	//                      document.getElementById('htImg').src = retUrl;
	                        Storage.setItem( "htImage", retUrl); //图片回写进对象
						    var str='<div class="img-item"><img src="'+retUrl+'"><i class="close-img mui-icon mui-icon-closeempty"></i></div>';
						    $('.htBox').prepend(str);
	                        layer.msg("上传成功");
	                    }else{
	                        layer.msg(data.msg);
	                    }
	
	                },
	         		error: function(xhr, type, errorThrown) {
	                    layer.msg('网络异常，请稍后再试！');
	                }
	            });
	        }
	    }
	    //将图片压缩转成base64
	    function getBase64Image(img) {
	        var canvas = document.createElement("canvas");
	        var width = img.width;
	        var height = img.height;
//			if(width > height) {
//	            if(width > 200) {
//	                height = Math.round(height *= 200 / width);
//	                width = 200;
//	            }
//	        } else {
//	            if(height > 200) {
//	                width = Math.round(width *= 200 / height);
//	                height = 200;
//	            }
//	        }
	        canvas.width = width; /*设置新的图片的宽度*/
	        canvas.height = height; /*设置新的图片的长度*/
	        var ctx = canvas.getContext("2d");
	        ctx.drawImage(img, 0, 0, width, height); /*绘图*/
	        var dataURL = canvas.toDataURL("image/png", 0.8);
	        return dataURL.replace("data:image/png;base64,", "");
	    }	
	
	
		mui('.mui-content').on('tap', 'img', function() {
			// 获取图片地址列表
		  	var images = document.querySelectorAll('.img-item img');
		  	var urls = [];
		  	for(var i = 0; i < images.length; i++) {
		    	urls.push(images[i].src);
		  	}
			var index = [].slice.call(images).indexOf(this);
        	plus.nativeUI.previewImage(urls, {
	            current: index,
	            loop: false,
	            indicator: 'number'
	        });

	    });
	    mui('.mui-content').on('tap', '.close-img', function() {
	    	$('.img-item').hide();
	    	$('#htImg').attr('src','');
	    });
	});
</script>

</body>
</html>

